\chapter{Proposed methodology}

CITE THE RELEVANT PAPERS IN EACH AREA

Given a 3D CAD model of some hydraulic machinery we want to generate how things work visualizations.
Namely, adding arrows depicting the fluid movement.

The problem can be subdivided into:
\begin{enumerate}
\item \textbf{Part analysis:} Detecting parts segments and inferring part properties.
\item \textbf{Fluid simulation:} Simulate how the fluid behaves in the previously detected parts.
\item \textbf{Flow visualization:} Display the fluid simulation data in a intuitive format.
\item \textbf{Explanatory illustration:} Transform the flow visualization data in one or several still images.
\end{enumerate}

To start with, input data is needed in the form on CAD 3D models.
A 3D visualization program such as SketchUp~\cite{Trimble2014} can be used to create, visualize and edit the models.
Once we have this input, we can begin the process to generate \textit{How things work} illustrations from them.

Part analysis involves two steps: part segmentation and part analysis.
Usually 3D models consist of meshes or point clouds were there is not a clear distinction between each piece.
Consequently, any additional analysis and simulation would be overly complicated without further simplifications.  
Therefore, a segmentation stage is needed in order to divide the model into its constituent components.
Part analysis consists of detecting the piece type, how it moves and interacts with others.
So the information saved for type would be axle, gear, reservoir, fluid conduct, etc.
In this classification parts are also organized considering fluid interaction criteria, e.g. if the piece interplays or not with the hydraulic fluid.
With respect to types of movement, it will be direction of movement, axis of rotation, axis of translation, etc.

Once the parts have been categorized and given an input force, we will have to simulate how the force is transmitted along the different elements.
In the special case where a component is a container of a fluid or is in direct contact with one, that force will have to be introduced in a fluid simulation algorithm.
The output of the simulation will then carry the information along to the next piece.

In order to visualize the fluid simulation data we will need to generate a visual cue that will intuitively indicate the fluid movement.
Either generating arrows indicating the overall fluid movement, with an animation or showing illustrative key frames.

Lastly, \textit{How things work} illustrations have to be generated from the flow visualization data, that is by itself a time variant data.
Therefore, techniques to embed motion in a single picture are used.

%How are we actually going to solve the problem.
%What is the proposed approach?
%Here we talk about what we are going to use.
%Still not clear what are the actual contributions of the proposal.

\section{Part analysis}

As discussed in Sections \ref{ch:intro} and \ref{ch:prevWork}, the first step is to segment the 3D CAD model mesh into useful parts for our task.
In Section \ref{sec:partAnalysis} we presented several options to segment meshes.
However, slippage analysis \cite{Yi2014} is the only method that can be applied directly to mechanical machinery.
Moreover, this method outputs the degrees of freedom for each part.
However, symmetry analysis can also be used to identify part rotation and translation axis \cite{Mitra2007}.
Therefore, a geometric analysis can be performed and we can work with models that do not have extra time information embedded.
Which is the case for most of the models available in the model libraries in Section \ref{sec:partAnalysis}.
However, none of the methods will automatically detect which parts will interact with the hydraulic fluid.
A first approach will be to manually mark them.
Nevertheless, other paths can be explored, such as heuristics that analyse the segment shape.
For example, the biggest cylindrical part will probably be the reservoir for the fluid, and the parts connected to it have high probability to have the hydraulic liquid flowing through then.
Other characteristics of the part have to be extracted, such as symmetry, edges, gear radius, etc.
1D features curves are useful for characterizing man-made parts \cite{Gal2009}.

%How are we going to detect the parts.
%Heuristics to detect were the liquid is?
%The slippage thing, with manual input when needed.
%I.e. to specify pump input or to say where the liquid is.

\section{Fluid simulation}

Once we have segmented the model and we know how each part can move and where can the hydraulic fluid flow, we need to calculate how the liquid interacts with the solid parts.
Given the characteristics of our problem, a physically accurate simulation with two way solid-fluid coupling is needed.
Fourier methods are discarded because we we will not be modelling vast amounts of fluid.
Then, we are left with either SPH, grid or hybrid simulations.
In terms of implementation complexity, grid methods are generally simpler, followed by SPH and lastly by hybrid systems.
If we look at quality of the simulation, hybrid and SPH tend to be better while grid methods lag behind.
However, the great disadvantage of grid simulations is the need to compute the simulation in highly divided grids in order to be able to display foams and other effects.
What is more, SPH have become quite popular in the last years as a general purpose fluid simulation tool.
Nevertheless, for hydraulic machinery the fluid will be constrained to a small area.
Moreover, extra realistic effects, such as foams or droplets, are irrelevant for this proposal.
Therefore, the previous grid disadvantage is no longer applicable, making methods such as \cite{Carlson2004}, the more appropriate type of simulation for our purposes.

%Using SPH, Grid or Hybrid simulation.
%Looks like grid since we are constrained to a small area and we do care about foams or other extra realism stuff.

\section{Flow visualization}

The next step is to generate the flow visualization from the simulation data.
Following the techniques discussed in Section~\ref{sec:flowVisualization}, we will use streamlines to visualize the flow.
\textit{How things work} illustrations do not have complex flow visualizations, as the objective is to understand roughly how the system works, not to give a perfect scientific representation of fluid dynamics.
Since our CAD models are 3D, 2D methods are ruled out.
There is not clear advantage in applying surface based integral objects as in hydraulic equipment there are not complex fluid flow situations.
Streamcomets offer a more natural way to visualize the flow, and having a translucent body means that occlusion is less likely to happen.
However, we consider streamcomets too complex for our purposes, therefore a simpler technique such as \cite{Wicke2009} would be used, with the optimizations presented by \cite{McLoughlin2013} should the generation be too slow.
This flow visualization should also include an optimization step, where the arrow placement would be improved.
Following the criteria in \cite{Mitra2010}, steps such as increasing arrow size in zones with more flow, replacing arrows in occluded areas or adding extra arrows in bigger areas, will be necessary to improve illustration quality.
%We are going to use stream lines on surfaces and then replace them by arrows.

\section{Solid parts visualization}

Solid parts visualization will be based on \cite{Mitra2010} methods for mechanical assemblies.
This stage involves placing arrows to convey part movement on the edge of each junction.
Different arrow types will be used, such as the ones shown in Figure \ref{fig:arrowTypes}.
Moreover, extra arrows will be added if the parts are too long and, if occlusion were to happen the arrow placement can be optimized.
However, if this is not enough, the type of the arrow could be switched if it produced an increased in visibility, from cap to side or viceversa.

\section{Key frames visualization}

To create key frame visualizations a simple approach is to sample the animation created from the fluid simulation at key points \cite{Mitra2010}.
In order to select those key points there are two cases: objects with cyclical movement and parts that do not.
The first ones would be spinning components, for example cylinders in engines whose movement is a periodic loop.
In this case, a displacement curve can be drawn and the sample points would be the extrema and middle frames in between.
In machinery that does not present cyclical movement, such as the simple cylinder shown in Figure~\ref{fig:h_pump}, it is evident that the extrema have to be included.
However, we are faced with a problem of either under or oversampling in the middle points, as the minimal number of key frames to illustrate the motion are unknown. 
%sample the animation
%For uniform translation only one in between, sample the animation at critical points

\section{Time line}

In Figure \ref{fig:timeLine} we present an estimated time line for the implementation of the proposal.
This estimation is highly dependant on the features to be implemented and the complexity of the CAD input models.
The output of one task is the input of the next, so overlapping naturally occurs when we switch to one task to the next, as we inevitably have to fix unexpected errors or introduce new features.
Moreover, the changes may backtrack to tasks several steps backs as shown in the isolated bars of Part Analysis or Fluid Simulation. 

\begin{figure}[!htbp]
\begin{center}

\begin{ganttchart}{1}{16}
	\gantttitle{Weeks}{16} \ganttnewline
	\gantttitlelist{1,...,16}{1} \ganttnewline
	%\ganttgroup{Group 1}{1}{7} \\
	\ganttbar{Part Analysis}{1}{4} \ganttbar{}{8}{8} \ganttbar{}{11}{11} \ganttnewline
	\ganttbar{Fluid Simulation}{4}{8} \ganttbar{}{11}{11} \ganttnewline
	%\ganttmilestone{Milestone}{7}
	%\ganttnewline
	\ganttbar{Flow Visualization}{8}{11} \ganttbar{}{14}{14} \ganttnewline
	\ganttbar{Solid Parts Visualization}{11}{14} \ganttnewline
	\ganttbar{Key Frames Visualization}{14}{16}
	%\ganttlink{elem2}{elem3} % Link to milestone
	%\ganttlink{elem3}{elem4} % Link from milestone
\end{ganttchart}

\end{center}
\caption{Time line for a four months completion of the proposal.}
\label{fig:timeLine}
\end{figure}